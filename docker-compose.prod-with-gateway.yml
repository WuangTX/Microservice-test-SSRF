services:
  postgres-user:
    image: postgres:15-alpine
    container_name: postgres-user
    environment:
      POSTGRES_USER: userservice
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: userservice_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    networks:
      - microservice-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U userservice -d userservice_db"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-product:
    image: postgres:15-alpine
    container_name: postgres-product
    environment:
      POSTGRES_USER: productservice
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: productservice_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_product_data:/var/lib/postgresql/data
    networks:
      - microservice-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U productservice -d productservice_db"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-order:
    image: postgres:15-alpine
    container_name: postgres-order
    environment:
      POSTGRES_USER: orderservice
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: orderservice_db
    ports:
      - "5435:5432"
    volumes:
      - postgres_order_data:/var/lib/postgresql/data
    networks:
      - microservice-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orderservice -d orderservice_db"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-inventory:
    image: postgres:15-alpine
    container_name: postgres-inventory
    environment:
      POSTGRES_USER: inventoryservice
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: inventoryservice_db
    ports:
      - "5436:5432"
    volumes:
      - postgres_inventory_data:/var/lib/postgresql/data
    networks:
      - microservice-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U inventoryservice -d inventoryservice_db"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================================
  # REDIS - For API Gateway Rate Limiting
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - microservice-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  user-service:
    image: tranquang04/user-service:latest
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-user:5432/userservice_db
      SPRING_DATASOURCE_USERNAME: userservice
      SPRING_DATASOURCE_PASSWORD: password123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: true
      JAVA_OPTS: "-Xmx512m -Xms256m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC"
    deploy:
      resources:
        limits:
          memory: 768m
    depends_on:
      postgres-user:
        condition: service_healthy
    networks:
      - microservice-network

  product-service:
    image: tranquang04/product-service:latest
    container_name: product-service
    ports:
      - "8082:8082"
    environment:
      DATABASE_URL: postgresql://productservice:password123@postgres-product:5432/productservice_db
      DEBUG: "True"
    depends_on:
      postgres-product:
        condition: service_healthy
    networks:
      - microservice-network

  inventory-service:
    image: tranquang04/inventory-service:latest
    container_name: inventory-service
    ports:
      - "8083:8083"
    environment:
      DATABASE_URL: postgresql://inventoryservice:password123@postgres-inventory:5432/inventoryservice_db
      PRODUCT_SERVICE_URL: http://product-service:8082
      FLASK_ENV: development
      FLASK_DEBUG: 1
    depends_on:
      postgres-inventory:
        condition: service_healthy
    networks:
      - microservice-network

  order-service:
    image: tranquang04/order-service:latest
    container_name: order-service
    ports:
      - "8084:8084"
    environment:
      DATABASE_URL: postgresql://orderservice:password123@postgres-order:5432/orderservice_db
      USER_SERVICE_URL: http://user-service:8081
      PRODUCT_SERVICE_URL: http://product-service:8082
      INVENTORY_SERVICE_URL: http://inventory-service:8083
      FLASK_ENV: development
      FLASK_DEBUG: 1
    depends_on:
      postgres-order:
        condition: service_healthy
    networks:
      - microservice-network

  # ============================================================
  # API GATEWAY - Centralized Security & SSRF Protection
  # ============================================================
  api-gateway:
    image: tranquang04/api-gateway:latest
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      # JWT Configuration (same secret as user-service)
      JWT_SECRET: "your-256-bit-secret-key-change-this-in-production-environment"
      
      # Service URLs
      USER_SERVICE_URL: http://user-service:8081
      PRODUCT_SERVICE_URL: http://product-service:8082
      INVENTORY_SERVICE_URL: http://inventory-service:8083
      ORDER_SERVICE_URL: http://order-service:8084
      
      # Redis Configuration for Rate Limiting
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      
      # Spring Boot Configuration
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: "-Xmx512m -Xms256m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC"
    deploy:
      resources:
        limits:
          memory: 768m
    depends_on:
      redis:
        condition: service_healthy
      user-service:
        condition: service_started
      product-service:
        condition: service_started
      inventory-service:
        condition: service_started
      order-service:
        condition: service_started
    networks:
      - microservice-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  frontend:
    image: tranquang04/frontend:latest
    container_name: frontend
    ports:
      - "3000:80"
    environment:
      REACT_APP_API_URL: ""
      CHOKIDAR_USEPOLLING: "true"
    networks:
      - microservice-network

volumes:
  postgres_user_data:
  postgres_product_data:
  postgres_order_data:
  postgres_inventory_data:

networks:
  microservice-network:
    driver: bridge
